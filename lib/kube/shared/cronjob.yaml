---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: $KUBE_APP-cronjob
  namespace: $KUBE_NS
  labels:
    app: $KUBE_APP-cronjob
    version: $GITHUB_SHA
  annotations:
    checkov.io/skip1: CKV_K8S_35=App uses third party containers
spec:
  schedule: "10 * * * *"
  concurrencyPolicy: "Replace"
  suspend: true
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: $KUBE_APP-cronjob
        spec:
          automountServiceAccountToken: false
          # Security: Run all containers as non-root user 10001 to prevent privilege escalation
          securityContext:
            runAsNonRoot: true
            runAsUser: 10001
            runAsGroup: 10001
            fsGroup: 10001
            # Security: Enable kernel-level syscall filtering to reduce attack surface
            seccompProfile:
              type: RuntimeDefault
          imagePullSecrets:
            - name: regcred
          containers:
            - name: $KUBE_APP
              image: $KUBE_DEPLOYMENT_IMAGE:$KUBE_DEPLOY_TAG@$KUBE_DEPLOY_DIGEST
              imagePullPolicy: Always
              # Security: Block privilege escalation, make filesystem read-only, drop all capabilities
              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                runAsNonRoot: true
                capabilities:
                  drop:
                    - ALL
              command:
                - /opt/app/scripts/export_doppler_env.sh
                - npm
                - run
                - script
                - --file=my_worker_script
              resources:
                limits:
                  cpu: 500m
                  memory: '400Mi'
                requests:
                  cpu: 250m
                  memory: '200Mi'
              env:
                - name: WEB_APP_HOST
                  value: $KUBE_INGRESS_HOSTNAME
              volumeMounts:
                # Security: Use temporary volume for writable directory since root filesystem is read-only
                - name: tmp
                  mountPath: /opt/app/tmp
                - name: secret-ref
                  mountPath: /opt/app/secrets
          volumes:
            - name: tmp
              emptyDir: {}
            - name: secret-ref
              secret:
                secretName: $DOPPLER_MANAGED_SECRET_NAME
          restartPolicy: OnFailure


