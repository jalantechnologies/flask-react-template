---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: $KUBE_APP-cronjob
  namespace: $KUBE_NS
  labels:
    app: $KUBE_APP-cronjob
    version: $GITHUB_SHA
spec:
  schedule: "10 * * * *"
  concurrencyPolicy: "Replace"
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: $KUBE_APP-cronjob
        spec:
          automountServiceAccountToken: false
          # Security: Run all containers as non-root user 10001 to prevent privilege escalation
          securityContext:
            runAsNonRoot: true
            runAsUser: 10001
            runAsGroup: 999
            fsGroup: 999
            # Security: Enable kernel-level syscall filtering to reduce attack surface
            seccompProfile:
              type: RuntimeDefault
          imagePullSecrets:
            - name: regcred
          containers:
            - name: $KUBE_APP
              image: $KUBE_DEPLOYMENT_IMAGE
              imagePullPolicy: Always
              # Security: Block privilege escalation, make filesystem read-only, drop all capabilities
              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                runAsNonRoot: true
                capabilities:
                  drop:
                    - ALL
              command: [ "npm", "run", "script", "--file=my_worker_script" ]
              resources:
                limits:
                  cpu: 500m
                  memory: '400Mi'
                requests:
                  cpu: 250m
                  memory: '200Mi'
              env:
                - name: WEB_APP_HOST
                  value: $KUBE_INGRESS_HOSTNAME
              envFrom:
                - secretRef:
                    name: $DOPPLER_MANAGED_SECRET_NAME
              volumeMounts:
                # Security: Use temporary volume for writable directory since root filesystem is read-only
                - name: tmp
                  mountPath: /opt/app/tmp
          volumes:
            - name: tmp
              emptyDir: {}
          restartPolicy: OnFailure
