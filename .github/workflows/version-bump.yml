name: version-bump

on:
  pull_request:
    types: [closed]
    branches:
      - main

permissions:
  contents: write

jobs:
  bump-version:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903
        with:
          node-version: '22.13.1'

      - name: Get semver label
        id: get-label
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(label => label.name);
            const semverLabels = ['semver: major', 'semver: minor', 'semver: patch'];
            const semverLabel = labels.find(label => semverLabels.includes(label));

            if (!semverLabel) {
              console.log('No semver label found on PR');
              return '';
            }

            const bumpType = semverLabel.split(': ')[1];
            console.log(`Found semver label: ${semverLabel}, bump type: ${bumpType}`);
            return bumpType;
          result-encoding: string

      - name: Bump version
        if: steps.get-label.outputs.result != ''
        run: |
          BUMP_TYPE="${{ steps.get-label.outputs.result }}"
          echo "Bumping version: $BUMP_TYPE"

          # Get current version from package.json
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $CURRENT_VERSION"

          # Parse version components
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          # Bump version based on type
          case $BUMP_TYPE in
            major)
              NEW_VERSION="$((MAJOR + 1)).0.0"
              ;;
            minor)
              NEW_VERSION="${MAJOR}.$((MINOR + 1)).0"
              ;;
            patch)
              NEW_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))"
              ;;
            *)
              echo "Unknown bump type: $BUMP_TYPE"
              exit 1
              ;;
          esac

          echo "New version: $NEW_VERSION"

          # Update package.json version
          npm version $NEW_VERSION --no-git-tag-version

          echo "new_version=$NEW_VERSION" >> $GITHUB_ENV

      - name: Commit and push version bump
        if: steps.get-label.outputs.result != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add package.json package-lock.json
          git commit -m "chore: bump version to ${{ env.new_version }}"
          git push origin main
