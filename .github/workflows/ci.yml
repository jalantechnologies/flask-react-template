name: ci

on:
  pull_request:
    types: [ opened, synchronize, reopened, ready_for_review ]

# Cancel in-progress CI runs when new commits are pushed to the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# Ensures CI workflow has minimal permissions for security
permissions:
  contents: read        # Read-only access to repo contents for safer workflows
  pull-requests: write  # Allow workflow to comment on, label, and update pull request as part of automation
  id-token: write       # Allow OIDC tokens for secure cloud authentication

jobs:
  lint:
    if: github.event.pull_request.state == 'open' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      - name: Setup Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c
        with:
          python-version: '3.11'

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903
        with:
          node-version: '22.13.1'
          cache: 'npm'

      - name: Install pipenv
        run: pip install pipenv

      - name: Install Python dependencies
        run: pipenv install --dev --deploy

      - name: Install Node dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

  sonarqube:
    if: github.event.pull_request.state == 'open' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 0

      - name: Get github-ci version
        id: ci_version
        run: |
          # Extract version from cd.yml workflow
          workflow_yaml=$(cat .github/workflows/cd.yml)
          uses_data=$(echo "$workflow_yaml" | grep 'jalantechnologies/github-ci')
          tag=$(echo $uses_data | sed -n 's/.*@\(.*\)/\1/p')
          echo "version=$(echo $tag)" >> $GITHUB_OUTPUT

      - name: Checkout github-ci
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          repository: jalantechnologies/github-ci
          path: platform
          ref: ${{ steps.ci_version.outputs.version }}

      - name: Run SonarQube analysis
        uses: ./platform/.github/actions/analyze
        with:
          sonar_host_url: ${{ vars.SONAR_HOST_URL }}
          sonar_token: ${{ secrets.SONAR_TOKEN }}
          branch: ${{ github.head_ref }}
          branch_base: main
          pull_request_number: ${{ github.event.number }}

  scan: 
    if: github.event.pull_request.state == 'open' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      # Detect changed files
      - name: Get changed files
        id: changes
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1
          git diff --name-only origin/${{ github.event.pull_request.base.ref }} HEAD > changed_files.txt

          if [ -s changed_files.txt ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      # Get changed files and copy to separate directory
      - name: Copy changed files for scanning
        id: copy_files
        if: steps.changes.outputs.changed == 'true'
        run: |
          mkdir -p changed_files_scan
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              mkdir -p "changed_files_scan/$(dirname "$file")"
              cp "$file" "changed_files_scan/$file"
            fi
          done < changed_files.txt
          
          echo "Files to scan:"
          find changed_files_scan -type f

      # Trivy filesystem scan on CHANGED files only
      - name: Trivy FS scan (changed files only)
        if: steps.changes.outputs.changed == 'true'
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        with:
          scan-type: filesystem
          scan-ref: changed_files_scan
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          exit-code: 1
          trivyignores: ".trivyignore"

      # Detect IaC changes
      - name: Detect IaC changes
        id: iac_changes
        run: |
          if grep -q '^lib/kube/' changed_files.txt; then
            echo "iac_changed=true" >> $GITHUB_OUTPUT
          else
            echo "iac_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Trivy IaC scan
        if: steps.iac_changes.outputs.iac_changed == 'true'
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        with:
          scan-type: config
          scan-ref: lib/kube
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          exit-code: 1
          trivyignores: ".trivyignore"

      - name: Run Checkov
        if: steps.iac_changes.outputs.iac_changed == 'true'
        uses: bridgecrewio/checkov-action@8f61ce5b8a3afb4ca94d236b75201878ded6d2cd
        with:
          directory: lib/kube
          quiet: true

      # Detect dependency changes
      - name: Detect dependency changes
        id: deps
        run: |
          if grep -Eq '(Dockerfile|package-lock.json|package.json|Pipfile.lock|requirements.txt)' changed_files.txt; then
            echo "deps_changed=true" >> $GITHUB_OUTPUT
          else
            echo "deps_changed=false" >> $GITHUB_OUTPUT
          fi

      # Build baseline Docker image from base branch
      - name: Checkout base branch for baseline
        if: steps.deps.outputs.deps_changed == 'true'
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          path: baseline

      - name: Build baseline Docker image
        if: steps.deps.outputs.deps_changed == 'true'
        run: |
          cd baseline
          docker build -t flask-react-app:baseline .
          cd ..

      # Scan baseline Docker image
      - name: Scan baseline Docker image
        if: steps.deps.outputs.deps_changed == 'true'
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        continue-on-error: true
        with:
          scan-type: image
          image-ref: flask-react-app:baseline
          format: json
          output: trivy-baseline.json
          severity: CRITICAL
          ignore-unfixed: true

      # Build PR Docker image
      - name: Build PR Docker image
        if: steps.deps.outputs.deps_changed == 'true'
        run: |
          docker build -t flask-react-app:pr .

      # Scan PR Docker image
      - name: Scan PR Docker image
        if: steps.deps.outputs.deps_changed == 'true'
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        continue-on-error: true
        with:
          scan-type: image
          image-ref: flask-react-app:pr
          format: json
          output: trivy-pr.json
          severity: CRITICAL
          ignore-unfixed: true

      # Compare and fail only on NEW CRITICAL vulnerabilities
      - name: Check for new Docker vulnerabilities
        if: steps.deps.outputs.deps_changed == 'true'
        run: |
          # Count CRITICAL vulnerabilities in baseline
          BASELINE_CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' trivy-baseline.json 2>/dev/null || echo 0)
          
          # Count CRITICAL vulnerabilities in PR
          PR_CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' trivy-pr.json 2>/dev/null || echo 0)
          
          # Calculate new vulnerabilities
          NEW_CRITICAL=$((PR_CRITICAL - BASELINE_CRITICAL))
          
          # Ensure non-negative
          [ $NEW_CRITICAL -lt 0 ] && NEW_CRITICAL=0
          
          echo "ðŸ“Š Docker Image Vulnerability Comparison:"
          echo "  Baseline CRITICAL: $BASELINE_CRITICAL"
          echo "  PR CRITICAL: $PR_CRITICAL"
          echo "  NEW CRITICAL: $NEW_CRITICAL"
          
          if [ "$NEW_CRITICAL" -gt 0 ]; then
            echo ""
            echo "âŒ Found $NEW_CRITICAL new CRITICAL vulnerabilities in Docker image"
            echo "Policy: Zero tolerance for new CRITICAL vulnerabilities"
            exit 1
          fi
          
          echo "âœ… No new CRITICAL vulnerabilities in Docker image"

  test:
    if: github.event.pull_request.state == 'open' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
      
      - name: Prepare coverage directory
        run: mkdir -p output

      - name: Run integration tests
        run: docker compose -f docker-compose.test.yml up --exit-code-from app

      - name: Copy coverage artifacts from container
        if: always()
        run: |
          if docker compose -f docker-compose.test.yml ps -q app >/dev/null 2>&1; then
            docker compose -f docker-compose.test.yml cp app:/app/output/coverage.xml output/coverage.xml || echo "coverage.xml not found in app container"
          fi

      - name: Tear down test stack
        if: always()
        run: docker compose -f docker-compose.test.yml down -v || true

      - name: Coverage report
        continue-on-error: true
        uses: irongut/CodeCoverageSummary@51cc3a756ddcd398d447c044c02cb6aa83fdae95
        with:
          filename: output/coverage.xml
          badge: true
          fail_below_min: true
          format: markdown
          hide_branch_rate: false
          hide_complexity: true
          indicators: true
          output: both
          thresholds: '60 80'

      - name: Add coverage PR comment
        continue-on-error: true
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405
        with:
          recreate: true
          path: code-coverage-results.md