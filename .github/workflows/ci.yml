name: ci

on:
  pull_request:
    types: [ opened, synchronize, reopened, ready_for_review ]

# Cancel in-progress CI runs when new commits are pushed to the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# Ensures CI workflow has minimal permissions for security
permissions:
  contents: read        # Read-only access to repo contents for safer workflows
  pull-requests: write  # Allow workflow to comment on, label, and update pull request as part of automation
  id-token: write       # Allow OIDC tokens for secure cloud authentication

jobs:
  lint:
    if: github.event.pull_request.state == 'open' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      - name: Setup Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c
        with:
          python-version: '3.11'

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903
        with:
          node-version: '22.13.1'
          cache: 'npm'

      - name: Install pipenv
        run: pip install pipenv

      - name: Install Python dependencies
        run: pipenv install --dev --deploy

      - name: Install Node dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

  sonarqube:
    if: github.event.pull_request.state == 'open' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 0

      - name: Get github-ci version
        id: ci_version
        run: |
          # Extract version from cd.yml workflow
          workflow_yaml=$(cat .github/workflows/cd.yml)
          uses_data=$(echo "$workflow_yaml" | grep 'jalantechnologies/github-ci')
          tag=$(echo $uses_data | sed -n 's/.*@\(.*\)/\1/p')
          echo "version=$(echo $tag)" >> $GITHUB_OUTPUT

      - name: Checkout github-ci
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          repository: jalantechnologies/github-ci
          path: platform
          ref: ${{ steps.ci_version.outputs.version }}

      - name: Run SonarQube analysis
        uses: ./platform/.github/actions/analyze
        with:
          sonar_host_url: ${{ vars.SONAR_HOST_URL }}
          sonar_token: ${{ secrets.SONAR_TOKEN }}
          branch: ${{ github.head_ref }}
          branch_base: main
          pull_request_number: ${{ github.event.number }}

  scan: 
    if: github.event.pull_request.state == 'open' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      # Detect changed files
      - name: Get changed files
        id: changes
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1
          git diff --name-only origin/${{ github.event.pull_request.base.ref }} HEAD > changed_files.txt

          if [ -s changed_files.txt ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      # Trivy filesystem scan on changed files
      - name: Run Trivy FS scan on changed files
        if: steps.changes.outputs.changed == 'true'
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        continue-on-error: true
        with:
          scan-type: filesystem
          scan-ref: .
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          exit-code: 1
          trivyignores: ".trivyignore"

      # Detect IaC changes
      - name: Detect IaC changes
        id: iac_changes
        run: |
          if grep -q '^lib/kube/' changed_files.txt; then
            echo "iac_changed=true" >> $GITHUB_OUTPUT
          else
            echo "iac_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Trivy IaC scan
        if: steps.iac_changes.outputs.iac_changed == 'true'
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        continue-on-error: true
        with:
          scan-type: config
          scan-ref: lib/kube
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          exit-code: 1
          trivyignores: ".trivyignore"

      - name: Run Checkov
        if: steps.iac_changes.outputs.iac_changed == 'true'
        uses: bridgecrewio/checkov-action@8f61ce5b8a3afb4ca94d236b75201878ded6d2cd
        continue-on-error: true
        with:
          directory: lib/kube
          quiet: true

      # Detect dependency changes
      - name: Detect dependency changes
        id: deps
        run: |
          if grep -Eq '(Dockerfile|package-lock.json|package.json|Pipfile.lock|requirements.txt)' changed_files.txt; then
            echo "deps_changed=true" >> $GITHUB_OUTPUT
          else
            echo "deps_changed=false" >> $GITHUB_OUTPUT
          fi

      # Extract new or upgraded dependencies
      - name: Extract new or upgraded dependencies
        id: dep_diff
        if: steps.deps.outputs.deps_changed == 'true'
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1

          # Get base branch package-lock.json
          git show origin/${{ github.event.pull_request.base.ref }}:package-lock.json > base-lock.json 2>/dev/null || echo '{"packages":{}}' > base-lock.json
          cp package-lock.json pr-lock.json

          # Extract package@version from both
          jq -r '
            .packages
            | to_entries[]
            | select(.key != "")
            | "\(.value.name)@\(.value.version)"
          ' base-lock.json | sort > base_deps.txt

          jq -r '
            .packages
            | to_entries[]
            | select(.key != "")
            | "\(.value.name)@\(.value.version)"
          ' pr-lock.json | sort > pr_deps.txt

          # Find new or upgraded packages (in PR but not in base)
          comm -13 base_deps.txt pr_deps.txt | cut -d@ -f1 | sort -u > changed_deps.txt

          echo "ðŸ“¦ Changed dependencies:"
          cat changed_deps.txt || echo "  (none)"

          if [ -s changed_deps.txt ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      # Build Docker image only if dependencies actually changed
      - name: Build Docker image
        if: steps.dep_diff.outputs.has_changes == 'true'
        run: |
          docker build -t flask-react-app:${{ github.sha }} .

      # Scan Docker image (JSON output for parsing)
      - name: Trivy Docker scan
        id: trivy_docker
        if: steps.dep_diff.outputs.has_changes == 'true'
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        continue-on-error: true
        with:
          scan-type: image
          image-ref: flask-react-app:${{ github.sha }}
          format: json
          output: trivy-docker.json
          severity: CRITICAL
          ignore-unfixed: true

      # Gate ONLY on CRITICAL vulnerabilities in NEW or UPGRADED packages
      - name: Gate on new dependency vulnerabilities
        if: steps.dep_diff.outputs.has_changes == 'true'
        run: |
          # Extract packages with CRITICAL vulnerabilities
          FOUND=$(jq -r '
            .Results[]
            | select(.Vulnerabilities != null)
            | .Vulnerabilities[]
            | select(.Severity == "CRITICAL")
            | .PkgName
          ' trivy-docker.json 2>/dev/null | sort -u || echo "")

          if [ -z "$FOUND" ]; then
            echo "âœ… No CRITICAL vulnerabilities found in Docker image"
            exit 0
          fi

          # Check if any CRITICAL vulns are in NEW or UPGRADED packages
          MATCH=$(comm -12 \
            <(echo "$FOUND" | sort) \
            <(sort changed_deps.txt) || echo "")

          if [ -n "$MATCH" ]; then
            echo "âŒ CRITICAL vulnerabilities introduced in new or upgraded dependencies:"
            echo "$MATCH"
            echo ""
            echo "Policy: Zero tolerance for CRITICAL vulnerabilities in new/upgraded packages"
            exit 1
          fi

          echo "âœ… No CRITICAL vulnerabilities in new or upgraded dependencies"
          echo "   (Existing vulnerabilities in unchanged packages are allowed)"

  test:
    if: github.event.pull_request.state == 'open' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
      
      - name: Prepare coverage directory
        run: mkdir -p output

      - name: Run integration tests
        run: docker compose -f docker-compose.test.yml up --exit-code-from app

      - name: Copy coverage artifacts from container
        if: always()
        run: |
          if docker compose -f docker-compose.test.yml ps -q app >/dev/null 2>&1; then
            docker compose -f docker-compose.test.yml cp app:/app/output/coverage.xml output/coverage.xml || echo "coverage.xml not found in app container"
          fi

      - name: Tear down test stack
        if: always()
        run: docker compose -f docker-compose.test.yml down -v || true

      - name: Coverage report
        continue-on-error: true
        uses: irongut/CodeCoverageSummary@51cc3a756ddcd398d447c044c02cb6aa83fdae95
        with:
          filename: output/coverage.xml
          badge: true
          fail_below_min: true
          format: markdown
          hide_branch_rate: false
          hide_complexity: true
          indicators: true
          output: both
          thresholds: '60 80'

      - name: Add coverage PR comment
        continue-on-error: true
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405
        with:
          recreate: true
          path: code-coverage-results.md